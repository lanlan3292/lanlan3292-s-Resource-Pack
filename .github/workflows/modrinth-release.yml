name: Publish to Modrinth

on:
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. 获取最新 Release 的元数据
      - name: Get Latest Release Info
        id: release_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          JSON=$(gh release view --json tagName,name,body)
          echo "tag=$(echo "$JSON" | jq -r .tagName)" >> $GITHUB_OUTPUT
          echo "name=$(echo "$JSON" | jq -r .name)" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON" | jq -r .body >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 2. 下载附件到本地 dist 目录
      - name: Download Assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p ./dist
          gh release download ${{ steps.release_info.outputs.tag }} --dir ./dist --pattern "*.zip"

      # 3. 准备本地文件路径列表（防弹处理：处理空格、特殊字符、统一路径格式）
      - name: Prepare File Paths
        id: paths
        run: |
          FILES_STRING=$(printf "'./dist/%s' " $(ls dist/*.zip | xargs -n1 basename))
          echo "files=$FILES_STRING" >> $GITHUB_OUTPUT

      # 4. 上传到 Modrinth
      - name: Upload to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: PUZix5YC
          name: ${{ steps.release_info.outputs.name }}
          version: ${{ steps.release_info.outputs.tag }}
          changelog: ${{ steps.release_info.outputs.body }}
          channel: release
          loaders: |-
            minecraft
          game-versions: |-
            1.21.x
          files: ${{ steps.paths.outputs.files }}
          file-types: |-
            ./dist/lRP-Main.zip=required-resource-pack
            ./dist/lRP-M.E.-Pure-Glass.zip=optional-resource-pack
            ./dist/lRP-M.E.-Derived.zip=optional-resource-pack
            ./dist/lRP-M.E.-C.R.I.zip=optional-resource-pack
