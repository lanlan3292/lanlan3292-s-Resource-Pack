name: Publish to Modrinth

on:
  release:
    types: [ published, prereleased ]
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Release Assets
        if: github.event_name == 'release'
        run: |
          echo "Detected release trigger. Waiting for 3 minutes to ensure assets are ready..."
          sleep 180

      # 1. 获取最新 Release 的元数据 (修正 gh 命令问题)
      - name: Get Latest Release Info
        id: release_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 使用 list 获取第一个出现的 tag (包含预览版)
          LATEST_TAG=$(gh release list --limit 1 | awk '{print $(NF-1)}')
          
          # 获取该特定 Tag 的详细 JSON 信息
          JSON=$(gh release view "$LATEST_TAG" --json tagName,name,body,isPrerelease)
          
          echo "tag=$(echo "$JSON" | jq -r .tagName)" >> $GITHUB_OUTPUT
          echo "name=$(echo "$JSON" | jq -r .name)" >> $GITHUB_OUTPUT
          
          # 自动判断发布频道：如果是预览版设为 alpha，否则为 release
          IS_PRERELEASE=$(echo "$JSON" | jq -r .isPrerelease)
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "channel=alpha" >> $GITHUB_OUTPUT
          else
            echo "channel=release" >> $GITHUB_OUTPUT
          fi
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON" | jq -r .body >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 2. 下载附件
      - name: Download Assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p ./dist
          gh release download ${{ steps.release_info.outputs.tag }} --dir ./dist --pattern "lRP-Main-All.zip"

      # 3. 准备文件路径
      - name: Auto-generate File Mappings
        id: mapper
        shell: python
        run: |
          import glob
          import os

          # 1. 获取所有 zip 文件
          files = sorted(glob.glob("dist/*.zip"))
          
          # 2. 生成文件列表字符串 (使用 \n 连接)
          files_str = "\n".join(files)
          
          # 3. 生成类型列表字符串
          types_list = []
          for f in files:
              # Use basename (name only) for file-types mapping — the action expects names, not paths
              name = os.path.basename(f)
              if "Main" in name:
                  types_list.append(f"{name}=required-resource-pack")
              else:
                  types_list.append(f"{name}=optional-resource-pack")
          
          types_str = "\n".join(types_list)

          # 4. 写入 GITHUB_OUTPUT (使用唯一的分隔符)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f"files<<PYTHON_EOF\n{files_str}\nPYTHON_EOF\n")
              fh.write(f"types<<PYTHON_EOF\n{types_str}\nPYTHON_EOF\n")

      # 4. 上传到 Modrinth
      - name: Upload to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: PUZix5YC
          name: ${{ steps.release_info.outputs.name }}
          version: ${{ steps.release_info.outputs.tag }}
          changelog: ${{ steps.release_info.outputs.body }}
          channel: ${{ steps.release_info.outputs.channel }}
          loaders: minecraft
          game-versions: |-
            25w14craftmine
            1.21.x
          files: ${{ steps.mapper.outputs.files }}
          primary-file: lRP-Main-All.zip
          file-types: ${{ steps.mapper.outputs.types }}