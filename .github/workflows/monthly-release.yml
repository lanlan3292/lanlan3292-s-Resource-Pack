name: Monthly Nightly Unified Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月 1 日 UTC 00:00

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        include:
          - branch: main
            label: Nightly Main
            filename: lRP-Main
          - branch: main-extra/pure-glass
            label: Nightly Main Extra Pure Glass
            filename: lRP-M.E.-Pure-Glass

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Process Release (ZIP + Notes)
        shell: bash
        run: |
          set -e

          DATE=$(date +'%Y-%m-%d-%H%M%S')
          COMMIT=$(git rev-parse --short HEAD)

          ZIP_NAME="${{ matrix.filename }}.zip"
          RELEASE_TAG="Nightly-$(date +'%Y-%m')"

          echo "ℹ️ Generating ZIP: $ZIP_NAME"
          zip -r -q "$ZIP_NAME" . -x ".git/*" -x "*.zip" -x ".github/*"
          if [ ! -f "$ZIP_NAME" ]; then
            echo "❌ ZIP file not created"
            exit 1
          fi

          # 确保 Release 存在
          set +e
          gh release view "$RELEASE_TAG" >/dev/null 2>&1
          if [ $? -ne 0 ]; then
            gh release create "$RELEASE_TAG" --title "Monthly Nightly Build $(date +'%Y-%m')" --notes "Initial Release Notes"
            sleep 2
          fi
          set -e

          # 上传 ZIP（--clobber 覆盖同名文件）
          gh release upload "$RELEASE_TAG" "$ZIP_NAME" --clobber

          # 临时文件保存当前 Release notes
          TMP_NOTES=$(mktemp)
          gh release view "$RELEASE_TAG" --json body -q .body > "$TMP_NOTES"

          # 获取本分支的 Changelog
          RAW_LOG=$(git log --pretty=format:"%h - %s" --since="1 month ago" | head -n 50)
          if [ -z "$RAW_LOG" ]; then
            CHANGELOG="No changes in the last month."
          else
            TOTAL_LINES=$(git log --pretty=format:"%h" --since="1 month ago" | wc -l)
            if [ "$TOTAL_LINES" -gt 50 ]; then
              RAW_LOG="$RAW_LOG"$'\n'"... and $((TOTAL_LINES - 50)) more changes."
            fi
            CHANGELOG="$RAW_LOG"
          fi

          # 检查是否已经包含本 commit，避免重复追加
          if grep -q "$COMMIT" "$TMP_NOTES"; then
            echo "ℹ️ Commit $COMMIT already included in Release notes, skipping append."
          else
            {
              echo "---"
              echo "### Branch: ${{ matrix.label }}"
              echo "- Commit: $COMMIT"
              echo "- Changelog:"
              while IFS= read -r line; do
                # JSON 安全转义
                ESCAPED_LINE=$(jq -Rn --arg str "$line" '$str')
                ESCAPED_LINE=${ESCAPED_LINE:1:-1}
                echo "  $ESCAPED_LINE"
              done <<< "$CHANGELOG"
            } >> "$TMP_NOTES"

            gh release edit "$RELEASE_TAG" --notes-file "$TMP_NOTES"
            sleep 1
          fi

          rm -f "$TMP_NOTES"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}