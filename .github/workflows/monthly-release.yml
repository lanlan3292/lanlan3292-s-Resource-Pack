name: Monthly Nightly Multi-Branch

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月 1 日 UTC 00:00

permissions:
  contents: write

jobs:
  release:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        include:
          - branch: main
            label: Nightly Main
            filename: lRP-Main
          - branch: main-extra/pure-glass
            label: Nightly Main Extra Pure Glass
            filename: lRP-M.E.-Pure-Glass

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Set Variables
        id: vars
        shell: bash
        run: |
          DATE=$(date +'%Y-%m-%d-%H%M%S')
          COMMIT=$(git rev-parse --short HEAD)

          SAFE_LABEL=$(echo "${{ matrix.filename }}" \
            | sed 's#[^a-zA-Z0-9]#-#g' \
            | sed 's/-\+/-/g' \
            | sed 's/^-//' \
            | sed 's/-$//')
          if [ -z "$SAFE_LABEL" ]; then
            SAFE_LABEL="branch"
          fi
          SAFE_LABEL=$(echo "$SAFE_LABEL" | cut -c1-50)

          ZIP_NAME="${{ matrix.filename }}-$DATE.zip"
          TAG_NAME="Nightly-${SAFE_LABEL}-$DATE"
          RELEASE_NAME="${{ matrix.label }} Nightly Build $DATE"

          CHANGELOG=$(git log --pretty=format:"%h - %s" --since="1 month ago")
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changes in the last month."
          fi

          NOTES_FILE="release_notes_${SAFE_LABEL}_$DATE.md"
          echo "### Build Info" > "$NOTES_FILE"
          echo "- Branch: ${{ matrix.branch }}" >> "$NOTES_FILE"
          echo "- Commit: $COMMIT" >> "$NOTES_FILE"
          echo "" >> "$NOTES_FILE"
          echo "### Changelog (Past Month)" >> "$NOTES_FILE"
          echo "$CHANGELOG" >> "$NOTES_FILE"

          echo "zip=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "notes_file=$NOTES_FILE" >> $GITHUB_OUTPUT

      - name: Create Zip Archive
        run: |
          zip -r -q "${{ steps.vars.outputs.zip }}" . -x ".git/*" -x "*.zip" -x ".github/*"
          if [ ! -f "${{ steps.vars.outputs.zip }}" ]; then
            echo "❌ Zip file ${{ steps.vars.outputs.zip }} not found, aborting."
            exit 1
          fi

      - name: Verify Notes File
        run: |
          if [ ! -f "${{ steps.vars.outputs.notes_file }}" ]; then
            echo "❌ Notes file ${{ steps.vars.outputs.notes_file }} not found, aborting."
            exit 1
          fi

      - name: Create Release with Retry
        run: |
          RETRIES=3
          COUNT=0
          until [ $COUNT -ge $RETRIES ]
          do
            if gh release view "${{ steps.vars.outputs.tag }}" >/dev/null 2>&1; then
              echo "⚠️ Release ${{ steps.vars.outputs.tag }} already exists, skipping creation."
              break
            fi
            set +e
            gh release create "${{ steps.vars.outputs.tag }}" \
              --title "${{ steps.vars.outputs.release_name }}" \
              --notes-file "${{ steps.vars.outputs.notes_file }}" \
              -- "${{ steps.vars.outputs.zip }}"
            STATUS=$?
            set -e
            if [ $STATUS -eq 0 ]; then
              echo "✅ Release created successfully."
              break
            else
              COUNT=$((COUNT+1))
              echo "⚠️ Attempt $COUNT failed, retrying in 5s..."
              sleep 5
            fi
          done
          if [ $COUNT -eq $RETRIES ]; then
            echo "❌ Release creation failed after $RETRIES attempts."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}