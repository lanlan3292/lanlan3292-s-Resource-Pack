name: Monthly Nightly Unified Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月 1 日 UTC 00:00

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        include:
          - branch: main
            label: Nightly Main
            filename: lRP-Main
          - branch: main-extra/pure-glass
            label: Nightly Main Extra Pure Glass
            filename: lRP-M.E.-Pure-Glass

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Process Release (ZIP + Replace Notes)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          DATE=$(date +'%Y-%m-%d-%H%M%S')
          COMMIT=$(git rev-parse --short HEAD)
          RELEASE_TAG="Nightly-$(date +'%Y-%m')"
          ZIP_NAME="${{ matrix.filename }}.zip"
          BRANCH_LABEL="${{ matrix.label }}"
          ANCHOR="<!-- ${BRANCH_LABEL// /_}_ANCHOR -->"

          echo "ℹ️ Generating ZIP: $ZIP_NAME"
          zip -r -q "$ZIP_NAME" . -x ".git/*" -x "*.zip" -x ".github/*"
          if [ ! -f "$ZIP_NAME" ]; then
            echo "❌ ZIP file not created"
            exit 1
          fi

          # 1. 确保 Release 存在（Prerelease）
          set +e
          gh release view "$RELEASE_TAG" >/dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "ℹ️ Creating new prerelease: $RELEASE_TAG"
            gh release create "$RELEASE_TAG" \
              --title "Monthly Nightly Build $(date +'%Y-%m')" \
              --notes "Initial Nightly Build" \
              --prerelease
            sleep 2
          fi
          set -e

          # 2. 上传 ZIP（覆盖同名文件）
          gh release upload "$RELEASE_TAG" "$ZIP_NAME" --clobber

          # 3. 获取当前 Release notes
          TMP_NOTES=$(mktemp)
          gh release view "$RELEASE_TAG" --json body -q .body > "$TMP_NOTES"

          # 4. 删除本分支旧日志（锚点 + 下一个 --- 或 EOF）
          CLEAN_NOTES=$(mktemp)
          awk -v anchor="$ANCHOR" '
            BEGIN { skip=0 }
            $0 ~ anchor { skip=1; next }
            /^---$/ && skip==1 { skip=0; next }
            skip==0 { print }
          ' "$TMP_NOTES" > "$CLEAN_NOTES"

          # 5. 生成本分支 Changelog
          RAW_LOG=$(git log --pretty=format:"%h - %s" --since="1 month ago" | head -n 50)
          if [ -z "$RAW_LOG" ]; then
            RAW_LOG="No changes in the last month."
          else
            TOTAL_LINES=$(git log --pretty=format:"%h" --since="1 month ago" | wc -l)
            [ "$TOTAL_LINES" -gt 50 ] && RAW_LOG="$RAW_LOG"$'\n'"... and $((TOTAL_LINES - 50)) more changes."
          fi

          # 6. 追加新日志到 CLEAN_NOTES
          {
            echo -e "\n$ANCHOR"
            echo "### Branch: $BRANCH_LABEL"
            echo "- **Last Build**: $(date +'%Y-%m-%d %H:%M:%S')"
            echo "- **Commit**: $COMMIT"
            echo "- **Changelog:**"
            echo "$RAW_LOG" | sed 's/^/  /'
            echo -e "\n---"
          } >> "$CLEAN_NOTES"

          # 7. 更新 Release notes（保持 Prerelease）
          gh release edit "$RELEASE_TAG" --notes-file "$CLEAN_NOTES" --prerelease

          rm -f "$TMP_NOTES" "$CLEAN_NOTES"