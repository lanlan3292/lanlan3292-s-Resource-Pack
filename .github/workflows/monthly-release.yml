name: Monthly Nightly Multi-Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ 1 æ—¥ UTC 00:00

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        include:
          - branch: main
            label: Nightly Main
            filename: lRP-Main
          - branch: main-extra/pure-glass
            label: Nightly Main Extra Pure Glass
            filename: lRP-M.E.-Pure-Glass
          - branch: main-extra/derived
            label: Nightly Main Extra Derived
            filename: lRP-M.E.-Derived

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Process Release (Multi-Release Mode)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # 1. å‡†å¤‡å˜é‡
          FULL_DATE=$(date +'%Y%m%d-%H%M%S-%3N')
          MONTH_TAG="Nightly-$(date +'%Y-%m')"
          # ä¸ºäº†ä¿ç•™åŽ†å²è®°å½•ï¼Œæ¯æ¬¡è¿è¡Œç”¨å”¯ä¸€ Tag
          UNIQUE_TAG="${MONTH_TAG}-${FULL_DATE}"
          
          COMMIT=$(git rev-parse --short HEAD)
          BRANCH_LABEL="${{ matrix.label }}"
          ZIP_NAME="${{ matrix.filename }}.zip"

          # 2. ç”Ÿæˆ ZIP
          echo "â„¹ï¸ Generating ZIP: $ZIP_NAME"
          zip -r -q "$ZIP_NAME" . -x ".git/*" -x "*.zip" -x ".github/*"
          if [ ! -f "$ZIP_NAME" ]; then
            echo "âŒ ZIP file not created"
            exit 1
          fi

          # 3. ç”Ÿæˆ Changelogï¼ˆæœ€å¤š 50 è¡Œï¼‰
          RAW_LOG=$(git log --pretty=format:"%h - %s" --since="1 month ago" | head -n 50)
          if [ -z "$RAW_LOG" ]; then
            RAW_LOG="No changes in the last month."
          else
            TOTAL_LINES=$(git log --pretty=format:"%h" --since="1 month ago" | wc -l)
            [ "$TOTAL_LINES" -gt 50 ] && RAW_LOG="$RAW_LOG"$'\n'"... and $((TOTAL_LINES - 50)) more changes."
          fi

          # 4. æž„é€  Release Notes
          TMP_NOTES=$(mktemp)
          {
            echo "### Branch: $BRANCH_LABEL"
            echo "- **Build Time**: $(date +'%Y-%m-%d %H:%M:%S')"
            echo "- **Commit**: \`$COMMIT\`"
            echo "- **Changelog:**"
            echo "$RAW_LOG" | sed 's/^/  /'
          } > "$TMP_NOTES"

          # 5. åˆ›å»ºå…¨æ–°çš„ Prerelease
          echo "ðŸš€ Creating distinct prerelease: $UNIQUE_TAG"
          gh release create "$UNIQUE_TAG" "$ZIP_NAME" \
            --title "[$BRANCH_LABEL] Build $FULL_DATE" \
            --notes-file "$TMP_NOTES" \
            --prerelease

          rm -f "$TMP_NOTES"